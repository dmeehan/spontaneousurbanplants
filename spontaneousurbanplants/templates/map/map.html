{% extends "base.html" %}
{% load staticfiles %}
{% load compress %}
{% block head_title %}Plant Map{% endblock %}

{% block extra_style %}

{% compress css %}
<link rel="stylesheet" href="{% static 'bower_components/leaflet/dist/leaflet.css' %}" />
<link rel="stylesheet" href="{% static 'bower_components/leaflet.markercluster/dist/MarkerCluster.css' %}" />
<link rel="stylesheet" href="{% static 'bower_components/leaflet.markercluster/dist/MarkerCluster.Default.css' %}" />
<link rel="stylesheet" href="{% static 'bower_components/lightbox2/css/lightbox.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'bower_components/tooltipster/css/tooltipster.css' %}" />
{% endcompress %}
{% endblock %}

{% block extra_js %}
{% compress js %}
<script src="{% static 'bower_components/lightbox2/js/lightbox.min.js' %}"></script>
<script src="{% static 'bower_components/leaflet/dist/leaflet.js' %}"></script>
<script src="{% static 'bower_components/leaflet.markercluster/dist/leaflet.markercluster.js' %}"></script>
<script src="{% static 'bower_components/leaflet-ajax/dist/leaflet.ajax.min.js' %}"></script>
<script src="{% static 'bower_components/spin.js/spin.js' %}"></script>
<script src="{% static 'js/leaflet.spin.js' %}"></script>
<script type="text/javascript" src="{% static 'bower_components/tooltipster/js/jquery.tooltipster.min.js' %}"></script>
<script src="{% static 'bower_components/spin.js/spin.js' %}"></script>
<script src="{% static 'js/leaflet.spin.js' %}">
</script>
{% endcompress %}
{% endblock %}

{% block content %}
<nav class="map-nav attributes">
	<ul>
	    {% for attribute in attribute_list %}
	        {% if attribute.icon %}
		<li style="background-image:url({{ attribute.icon.url }})"><a data-tag="{{ attribute.hashtag }}"
		data-name="{{ attribute.name }}: "
		data-description="{{ attribute.description }}"
		title="{{ attribute.name }}" 
		class="layer-link tooltip" href="#">{{ attribute.name }}</a></li>
		{% endif %}
	    {% endfor %}
	</ul>
</nav>
<section class="info">
	<div class="map" id="map"></div>
	<aside class="details">
		<strong class="name"></strong>
		<span class="description">Click on the interactive map to discover SUP in your neighborhood. Filter by performance or species by using the icons.</span>
	</aside>
</section>
<nav class="map-nav categories">
	<ul>
	<li class="all active"><a data-tag="all"
		data-name=""
		data-description="Click on the interactive map to discover SUP in your neighborhood. Filter by performance or species by using the icons."
		title="All" 
		class="layer-link tooltip" 
		href="#">{{ plant.common_name }}</a></li>
	</ul>
	<ul>
		{% for category in category_list %}
		<li style="background-image:url({{ category.icon.url }})"><a 
		data-name="{{ category.name }} "
		data-description="({{ category.description }})"
		title="{{ category.name }}" 
		class="layer-link tooltip"
		href="#">{{ category.name }}</a></li>
		{% endfor %}
	</ul>


</nav>
{% endblock content %}
{% block extra_body %}
<script>
	// style

	var defaultMarkerStyle = {
        radius: 10,
        fillColor: "#d2df3b",
        color: "#d2df3b",
        weight: 0,
        opacity: 0,
        fillOpacity: 0.8
    };

	var markerColors = {
		defaultColor: "#d2df3b",
	    SUPDisturbanceadapted: "#eb1f89",
	    SUPwildlife: "#74498e",
	    SUPphytoremediation: "#FFD847",
	    SUPmedicinal: "#01a4a0",
	    SUPmitigatingurbanheat: "#455657",
	    SUPretainstormh2o: "#0e7599",
	    SUPnoiseregulation: "#0a4874",
	    SUPpreventerosion: "#dd4d15",
	    SUPinvasive: "#f55100",
	    SUPEdible: "#006838",
	    SUPSequesterCO2: "#1bda9f",
	}

	var emptyMarkerStyle = {
        opacity: 0,
        fillOpacity: 0
    };

	// create a map in the "map" div
	var map = L.map('map');

	// add an OpenStreetMap tile layer
	var streets = L.tileLayer('http://api.tiles.mapbox.com/v3/mnegret.i9i0hhj2/{z}/{x}/{y}.png', {
    	attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(map);


	// if linking to specific image: load image, display on map, zoom, and open popup
	{% if image_id %}
		var image = L.geoJson.ajax('{% url "api-image-detail" image_id %}?format=json', {
			pointToLayer: function (feature, latlng) {
        		return L.circleMarker(latlng, emptyMarkerStyle);
    		},
			onEachFeature: function(feature, layer) {
				var popupContent = '<a data-lightbox="' + feature.properties.id + '" data-title="'+ feature.properties.caption + '" href="'+ feature.properties.remote_standard_resolution_url + '"><img width="150" height="150" src="' + feature.properties.remote_thumbnail_url + '"></a>';
				marker = layer;
        		marker.bindPopup(popupContent);
			}
		}).addTo(map);

		image.on('data:loaded',function(){
			center = image.getBounds().getCenter();
			map.setView(center, 15);
			marker.openPopup();
		});
	{% else %}
	    map.setView([40.676898, -73.995308], 11);  
	{% endif %}



	// object that hold marker clusters
	var markerClusterGroups = {}


	var all_layer = L.markerClusterGroup({ 
		singleMarkerMode: true,
		maxClusterRadius: 30,
		showCoverageOnHover: false,
		iconCreateFunction: function(cluster) {
			var childCount = cluster.getChildCount();
			var radius = 10;
			var area = (Math.PI * (radius * radius)) * childCount;
		    var size = Math.sqrt(area / Math.PI) * 0.5;
		    if (size < 10) { size = 10 }
		     	var html = '<div style="width:'+size+'px;height:'+size+'px;"></div>';
		      	return new L.DivIcon({ html: html, className: 'marker-cluster', iconSize: new L.Point(size, size) });
		    }
	});

	markerClusterGroups['all'] = all_layer 

	map.spin(true);

	var all_data = L.geoJson.ajax('{% url "api-image-list" %}?format=json', {
		onEachFeature: function onEachFeature(feature, layer) {
			all_layer.addLayer(layer);

			var popupContent = '<a data-lightbox="' + feature.properties.id + '" data-title="'+ feature.properties.caption + '" href="'+ feature.properties.remote_standard_resolution_url + '"><img width="150" height="150" src="' + feature.properties.remote_thumbnail_url + '"></a>';

    		layer.bindPopup(popupContent);
		}
	});

	all_data.on('data:loaded',function(){
    	map.spin(false);
	});


	map.addLayer(all_layer);
	

{% for attribute in attribute_list %}

	var {{ attribute.hashtag }}_layer = L.markerClusterGroup({ 
		singleMarkerMode: true,
		maxClusterRadius: 30,
		showCoverageOnHover: false,
		iconCreateFunction: function(cluster) {
			var childCount = cluster.getChildCount();
			var radius = 10;
			var area = (Math.PI * (radius * radius)) * childCount;
		    var size = Math.sqrt(area / Math.PI) * 0.5;
		    if (size < 10) { size = 10 }
		     	var html = '<div style="width:'+size+'px;height:'+size+'px;"></div>';
		      	return new L.DivIcon({ html: html, className: 'marker-cluster marker-cluster-{{ attribute.hashtag }}', iconSize: new L.Point(size, size) });
		    }
	});

	markerClusterGroups['{{ attribute.hashtag}}'] = {{ attribute.hashtag}}_layer 

	var {{ attribute.hashtag }}_data = L.geoJson.ajax('{% url "api-image-list" %}?tag={{ attribute.hashtag }}&format=json', {
		onEachFeature: function onEachFeature(feature, layer) {
			{{ attribute.hashtag }}_layer.addLayer(layer);


			var popupContent = '<a data-lightbox="' + feature.properties.id + '" data-title="'+ feature.properties.caption + '" href="'+ feature.properties.remote_standard_resolution_url + '"><img width="150" height="150" src="' + feature.properties.remote_thumbnail_url + '"></a>';

    		layer.bindPopup(popupContent);
		}
	});

	//map.addLayer({{ attribute.hashtag}}_layer);

{% endfor %}


{% for plant in plant_list %}

	var {{ plant.hashtag }}_layer = L.markerClusterGroup({ 
		singleMarkerMode: true,
		maxClusterRadius: 30,
		showCoverageOnHover: false,
		iconCreateFunction: function(cluster) {
			var childCount = cluster.getChildCount();
			var radius = 10;
			var area = (Math.PI * (radius * radius)) * childCount;
		    var size = Math.sqrt(area / Math.PI) * 0.5;
		    if (size < 10) { size = 10 }
		     	var html = '<div style="width:'+size+'px;height:'+size+'px;"></div>';
		      	return new L.DivIcon({ html: html, className: 'marker-cluster', iconSize: new L.Point(size, size) });
		    }
	});

	markerClusterGroups['{{ plant.hashtag}}'] = {{ plant.hashtag}}_layer 

	var {{ plant.hashtag }}_data = L.geoJson.ajax('{% url "api-image-list" %}?tag={{ plant.hashtag }}&format=json', {
		onEachFeature: function onEachFeature(feature, layer) {
			{{ plant.hashtag }}_layer.addLayer(layer);

			var popupContent = '<a data-lightbox="' + feature.properties.id + '" data-title="'+ feature.properties.caption + '" href="'+ feature.properties.remote_standard_resolution_url + '"><img width="150" height="150" src="' + feature.properties.remote_thumbnail_url + '"></a>';

    		layer.bindPopup(popupContent);
		}
	});


{% endfor %}

	function removeAllLayers() {
		map.eachLayer(function (layer) {
			if (layer != streets) {
    			map.removeLayer(layer)
    		}
		});
	}


    // click function to change between layers
	$('a.layer-link').click(function (e) {
		//Get the id of the element clicked
       var tagName = $(this).data('tag');
       // look up layer object by id 
  
	   if (markerColors[tagName] === undefined) {
	       color = markerColors['defaultColor'];
	   } else {
		   color = markerColors[tagName];
	   }

	   removeAllLayers();

	   map.addLayer(markerClusterGroups[tagName]);
	   map.fitBounds(markerClusterGroups[tagName]);

	   $(".leaflet-popup-close-button").click()
	   $('.name').text($(this).data('name'));
	   $('.description').text($(this).data('description'));
	   $('aside.details').css( 'border-color', color )
	   $('.map-nav ul li').removeClass("active");
	   $(this).parent().toggleClass("active");

	})
</script>


<script>
     $(document).ready(function() {
     	$('.tooltip').tooltipster({
   			position: 'right'
     	});
     });
</script>
{% endblock extra_body %}
