{% extends "base.html" %}
{% load staticfiles %}
{% load compress %}
{% block head_title %}Plant Map{% endblock %}

{% block extra_style %}
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
{% compress css %}
<script src="{% static 'bower_components/leaflet.markercluster/dist/Markercluster.css' %}"></script>
{% endcompress %}
{% endblock %}

{% block extra_js %}
<script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
{% compress js %}
<script src="{% static 'bower_components/leaflet.markercluster/dist/leaflet.markercluster.js' %}"></script>
<script src="{% static 'bower_components/leaflet-ajax/dist/leaflet.ajax.min.js' %}"></script>
{% endcompress %}
{% endblock %}

{% block content %}
<nav class="map-nav attributes">
	<ul>
	    {% for attribute in attribute_list %}
		<li style="background-image:url({{ attribute.icon.url }})"><a data-tag="{{ attribute.hashtag }}"
		data-description="{{ attribute.description }}"
		title="{{ attribute.hashtag }}" class="layer-link" href="#">{{ attribute.name }}</a></li>
	    {% endfor %}
	</ul>
</nav>
<section class="info">
	<div class="map" id="map"></div>
	<aside class="description">Click on the interactive map to discover SUP in your neighborhood. Filter by performance or species by using the icons.</aside>
</section>
<nav class="map-nav plants">
	<ul class="all">
	   <li><a
		title="all" class="layer-link active" href="{% url 'map' %}">{{ plant.common_name }}</a></li>
	</ul>
	<ul class="pre">
		{% for plant in plant_list|slice:":8" %}
		<li style="background-image:url({{ plant.icon.url }})"><a data-tag="{{ plant.hashtag }}"
		data-description="{{ plant.common_name }} ({{ plant.latin_name }})"
		title="{{ plant.hashtag }}" class="layer-link" href="#">{{ plant.common_name }}</a></li>
		{% endfor %}
	</ul>
        <ul class="post">
        {% for plant in plant_list|slice:"8:" %}
        <li style="background-image:url({{ plant.icon.url }})"><a data-tag="{{ plant.hashtag }}"
        data-description="{{ plant.common_name }} ({{ plant.latin_name }})"
        title="{{ plant.hashtag }}" class="layer-link" href="#">{{ plant.common_name }}</a></li>
        {% endfor %}
        </ul>


</nav>
{% endblock content %}
{% block extra_body %}
<script>

	 // create a map in the "map" div, set the view to a given place and zoom
	var map = L.map('map').setView([40.676898, -73.995308], 11);

	//object to store layers for each tag
	
	var mapLayerGroups = {};

	// add an OpenStreetMap tile layer
	var streets = L.tileLayer('http://api.tiles.mapbox.com/v3/mnegret.hi0oglpi/{z}/{x}/{y}.png', {
    	attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(map);


	var defaultMarkerStyle = {
    	radius: 20,
		fillColor: "#d9e45c",
		color: "#000",
		weight: 0,
		opacity: 0,
		fillOpacity: 0.8
	};

	var markerColors = {
		defaultColor: "#d9e45c",
	    SUPDisturbanceadapted: "#eb1f89",
	    SUPwildlife: "#74498e",
	    SUPphytoremediation: "#edb800",
	    SUPmedicinal: "#01a4a0",
	    SUPmitigatingurbanheat: "#455657",
	    SUPretainstormh2o: "#0e7599",
	    SUPnoiseregulation: "#0a4874",
	    SUPpreventerosion: "#dd4d15",
	    SUPinvasive: "#f55100",
	    SUPEdible: "#b7be1e",
	    SUPcarboncapture: "#1bda9f",
	}

	var markers = new L.MarkerClusterGroup();

	/*
	 *for all features create a layerGroup for each feature type and add the feature to the    layerGroup
	*/
	function onEachFeature(feature, layer) {

		var tags = feature.properties.tags

		for (var i = 0; i < tags.length; i++) { 
			var lg = mapLayerGroups[tags[i]];

			if (lg === undefined) {
	    	    lg = new L.layerGroup();
	        	//store layer
	    		mapLayerGroups[tags[i]] = lg;
	    	}

	    	lg.addLayer(layer);
	    }


    	var popupContent = '<img width="150" height="150" src="' + feature.properties.remote_thumbnail_url + '">';
        layer.bindPopup(popupContent);     
	}

	//var locations = L.geoJson.ajax(
    //  "{% url 'api-image-list' %}?format=json", {
    //    pointToLayer: function (feature, latlng) {
    //   		return L.circleMarker(latlng, defaultMarkerStyle).addTo(map);
    //		},
    //		onEachFeature: onEachFeature
	//})

	var locations = $.getJSON("{% url 'api-image-list' %}?format=json", function(data) {
		L.geoJson(data, {
    		pointToLayer: function (feature, latlng) {
       		return L.circleMarker(latlng, defaultMarkerStyle);
    		},
    		onEachFeature: onEachFeature
		}).addTo(map);
	})

	function removeAllLayers() {
		map.eachLayer(function (layer) {
			if (layer != streets) {
    			map.removeLayer(layer)
    		}
		});
	}

	$('a.layer-link').click(function (e) {
		//Get the id of the element clicked
       var tag = $(this).data('tag');
       // look up layer object by id
	   var tagLayer = mapLayerGroups[tag]; 
	   removeAllLayers();
       map.addLayer(tagLayer);
       var text = $(this).data('description');
	   if (markerColors[tag] === undefined) {
	       color = markerColors['defaultColor'];
		} else {
		   color = markerColors[tag];
		}
	   $('aside.description').text(text);
	   $('aside.description').css( 'border-color', color )
       e.preventDefault()
       map.eachLayer(function (layer) {
		if (layer != streets) {
			//console.log(layer)
			layer.setStyle({ fillColor: color });
		}
	   });
	})
	
	

    //markers.addLayer(locations);
	//locations.addTo(map);
	//map.fitBounds(markers.getBounds());



</script>
{% endblock extra_body %}
